<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard — Farm Phoomjai & Jiaranai Garden</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-body">
  <!-- Admin Navbar -->
  <nav class="admin-navbar">
    <div class="admin-navbar-brand">
      <img src="images/logo_farm.jpg" alt="Farm Phoomjai">
      <span data-i18n="adminPanel">แผงควบคุม</span>
    </div>
    <div class="admin-navbar-actions">
      <button id="langToggle" class="lang-toggle" title="เปลี่ยนภาษา">
        <i class="fas fa-globe"></i> <span id="currentLang">TH</span>
      </button>
      <a href="index.html" class="admin-nav-link" target="_blank">
        <i class="fas fa-external-link-alt"></i> <span data-i18n="viewSite">ดูเว็บไซต์</span>
      </a>
      <button id="logoutBtn" class="admin-logout-btn">
        <i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">ออกจากระบบ</span>
      </button>
    </div>
  </nav>

  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <nav class="admin-sidebar-nav">
        <a href="#" class="sidebar-link active" data-page="dashboard">
          <i class="fas fa-tachometer-alt"></i>
          <span data-i18n="dashboard">แดชบอร์ด</span>
        </a>
        <a href="#" class="sidebar-link" data-page="add-product">
          <i class="fas fa-plus-circle"></i>
          <span data-i18n="addProduct">เพิ่มสินค้า</span>
        </a>
        <a href="#" class="sidebar-link" data-page="list-products">
          <i class="fas fa-list"></i>
          <span data-i18n="productList">รายการสินค้า</span>
        </a>
        <a href="#" class="sidebar-link" data-page="categories">
          <i class="fas fa-tags"></i>
          <span data-i18n="categories">หมวดหมู่</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <!-- Dashboard Page -->
      <section id="dashboard-page" class="admin-page active">
        <h1 class="admin-page-title" data-i18n="dashboard">แดชบอร์ด</h1>
        <div class="dashboard-stats">
          <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-box"></i></div>
            <div class="stat-info">
              <h3 id="totalProducts">0</h3>
              <p data-i18n="totalProducts">สินค้าทั้งหมด</p>
            </div>
          </div>
          <div id="categoryStatsContainer">
            <!-- Dynamic category stats will be loaded here -->
          </div>
        </div>
        <div class="dashboard-welcome">
          <h2 data-i18n="welcomeTitle">ยินดีต้อนรับสู่แผงควบคุม</h2>
          <p data-i18n="welcomeDesc">จัดการสินค้าของฟาร์มได้ง่ายๆ เพิ่มสินค้าใหม่ แก้ไข หรือลบสินค้าจากแคตตาล็อก</p>
          <div class="quick-actions">
            <button class="btn btn-primary" onclick="showPage('add-product')">
              <i class="fas fa-plus"></i> <span data-i18n="addNewProduct">เพิ่มสินค้าใหม่</span>
            </button>
            <button class="btn btn-outline" onclick="showPage('list-products')">
              <i class="fas fa-list"></i> <span data-i18n="viewAllProducts">ดูสินค้าทั้งหมด</span>
            </button>
          </div>
        </div>
      </section>

      <!-- Add Product Page -->
      <section id="add-product-page" class="admin-page">
        <h1 class="admin-page-title" data-i18n="addProduct">เพิ่มสินค้าใหม่</h1>
        <form id="addProductForm" class="admin-form">
          <div class="form-row">
            <div class="form-group">
              <label for="productName" data-i18n="productName">ชื่อสินค้า *</label>
              <input type="text" id="productName" data-i18n-placeholder="productNamePlaceholder" placeholder="เช่น มะเขือเทศสด" required>
            </div>
            <div class="form-group">
              <label for="productCategory" data-i18n="category">หมวดหมู่ *</label>
              <select id="productCategory" required>
                <!-- Categories loaded dynamically -->
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="productDescription" data-i18n="description">รายละเอียด *</label>
            <textarea id="productDescription" rows="3" data-i18n-placeholder="descriptionPlaceholder" placeholder="อธิบายสินค้าของคุณ..." required></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="productPrice" data-i18n="price">ราคา (฿)</label>
              <input type="text" id="productPrice" data-i18n-placeholder="pricePlaceholder" placeholder="เช่น 50 หรือ ตามฤดูกาล">
            </div>
            <div class="form-group">
              <label for="productBadge" data-i18n="badge">ป้าย (ไม่บังคับ)</label>
              <select id="productBadge">
                <option value="" data-i18n="noBadge">ไม่มีป้าย</option>
                <option value="Popular" data-i18n="popular">ยอดนิยม</option>
                <option value="New" data-i18n="new">ใหม่</option>
                <option value="Sale" data-i18n="sale">ลดราคา</option>
                <option value="Organic" data-i18n="organic">ออร์แกนิค</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="productImage" data-i18n="imageUrl">URL รูปภาพ</label>
            <input type="text" id="productImage" data-i18n-placeholder="imageUrlPlaceholder" placeholder="ใส่ URL รูปภาพ หรือเว้นว่างเพื่อใช้รูปเริ่มต้น">
            <small data-i18n="imageUrlHint">เว้นว่างเพื่อใช้รูปเริ่มต้นตามหมวดหมู่</small>
          </div>
          <div class="form-group">
            <label data-i18n="uploadImage">อัพโหลดรูปภาพ (ไม่บังคับ)</label>
            <div class="image-upload-area" id="imageUploadArea">
              <i class="fas fa-cloud-upload-alt"></i>
              <p data-i18n="dragDrop">คลิกเพื่ออัพโหลด หรือลากไฟล์มาวาง</p>
              <input type="file" id="productImageFile" accept="image/*" hidden>
            </div>
            <div id="imagePreview" class="image-preview"></div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i> <span data-i18n="addProduct">เพิ่มสินค้า</span>
            </button>
            <button type="reset" class="btn btn-outline">
              <i class="fas fa-undo"></i> <span data-i18n="reset">รีเซ็ต</span>
            </button>
          </div>
        </form>
      </section>

      <!-- List Products Page -->
      <section id="list-products-page" class="admin-page">
        <h1 class="admin-page-title" data-i18n="productList">รายการสินค้า</h1>
        <div class="product-list-header">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchProducts" data-i18n-placeholder="searchProducts" placeholder="ค้นหาสินค้า...">
          </div>
          <select id="filterCategory" class="filter-select">
            <!-- Categories loaded dynamically -->
          </select>
        </div>
        <div class="product-table-container">
          <table class="product-table">
            <thead>
              <tr>
                <th data-i18n="image">รูปภาพ</th>
                <th data-i18n="name">ชื่อ</th>
                <th data-i18n="category">หมวดหมู่</th>
                <th data-i18n="price">ราคา</th>
                <th data-i18n="badge">ป้าย</th>
                <th data-i18n="actions">จัดการ</th>
              </tr>
            </thead>
            <tbody id="productTableBody">
              <!-- Products will be loaded here -->
            </tbody>
          </table>
          <div id="noProducts" class="no-products" style="display: none;">
            <i class="fas fa-box-open"></i>
            <p data-i18n="noProductsFound">ไม่พบสินค้า</p>
            <button class="btn btn-primary" onclick="showPage('add-product')" data-i18n="addFirstProduct">เพิ่มสินค้าแรกของคุณ</button>
          </div>
        </div>
      </section>

      <!-- Categories Page -->
      <section id="categories-page" class="admin-page">
        <h1 class="admin-page-title" data-i18n="categories">หมวดหมู่</h1>
        <div class="categories-container">
          <div class="category-form-section">
            <h3 data-i18n="addNewCategory">เพิ่มหมวดหมู่ใหม่</h3>
            <form id="addCategoryForm" class="admin-form">
              <div class="form-row">
                <div class="form-group">
                  <label data-i18n="categoryNameEn">ชื่อหมวดหมู่ (อังกฤษ)</label>
                  <input type="text" id="categoryName" placeholder="e.g., fruits" required>
                </div>
                <div class="form-group">
                  <label data-i18n="categoryNameTh">ชื่อหมวดหมู่ (ไทย)</label>
                  <input type="text" id="categoryNameTh" placeholder="เช่น ผลไม้" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label data-i18n="categoryIcon">ไอคอน</label>
                  <div class="icon-picker-container">
                    <button type="button" id="iconPickerBtn" class="icon-picker-btn">
                      <i id="selectedIconPreview" class="fas fa-box"></i>
                      <span data-i18n="selectIcon">เลือกไอคอน</span>
                      <i class="fas fa-chevron-down"></i>
                    </button>
                    <input type="hidden" id="categoryIcon" value="fas fa-box">
                  </div>
                </div>
                <div class="form-group">
                  <label data-i18n="categoryColor">สี</label>
                  <div class="color-picker-container">
                    <button type="button" id="colorPickerBtn" class="color-picker-btn">
                      <span id="colorPreview" class="color-preview" style="background: #4a7c59"></span>
                      <span data-i18n="selectColor">เลือกสี</span>
                    </button>
                    <input type="hidden" id="categoryColor" value="#4a7c59">
                  </div>
                </div>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-plus"></i> <span data-i18n="addCategory">เพิ่มหมวดหมู่</span>
                </button>
              </div>
            </form>
          </div>
          <div class="category-list-section">
            <h3 data-i18n="existingCategories">หมวดหมู่ที่มีอยู่</h3>
            <div id="categoryList" class="category-list"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Edit Product Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-i18n="editProduct">แก้ไขสินค้า</h2>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editProductForm" class="admin-form">
        <input type="hidden" id="editProductId">
        <div class="form-row">
          <div class="form-group">
            <label for="editName" data-i18n="productName">ชื่อสินค้า *</label>
            <input type="text" id="editName" required>
          </div>
          <div class="form-group">
            <label for="editCategory" data-i18n="category">หมวดหมู่ *</label>
            <select id="editCategory" required>
              <!-- Categories loaded dynamically -->
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="editDescription" data-i18n="description">รายละเอียด *</label>
          <textarea id="editDescription" rows="3" required></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editPrice" data-i18n="price">ราคา (฿)</label>
            <input type="text" id="editPrice">
          </div>
          <div class="form-group">
            <label for="editBadge" data-i18n="badge">ป้าย</label>
            <select id="editBadge">
              <option value="" data-i18n="noBadge">ไม่มีป้าย</option>
              <option value="Popular" data-i18n="popular">ยอดนิยม</option>
              <option value="New" data-i18n="new">ใหม่</option>
              <option value="Sale" data-i18n="sale">ลดราคา</option>
              <option value="Organic" data-i18n="organic">ออร์แกนิค</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="editImage" data-i18n="imageUrl">URL รูปภาพ</label>
          <input type="text" id="editImage">
        </div>
        <div class="form-group">
          <label data-i18n="uploadNewImage">อัพโหลดรูปใหม่</label>
          <div class="image-upload-area" id="editImageUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p data-i18n="dragDrop">คลิกเพื่ออัพโหลด หรือลากไฟล์มาวาง</p>
            <input type="file" id="editProductImageFile" accept="image/*" hidden>
          </div>
          <div id="editImagePreview" class="image-preview"></div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> <span data-i18n="save">บันทึก</span>
          </button>
          <button type="button" class="btn btn-outline" onclick="closeEditModal()" data-i18n="cancel">ยกเลิก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content modal-small">
      <div class="modal-header">
        <h2 data-i18n="confirmDelete">ยืนยันการลบ</h2>
        <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p><span data-i18n="confirmDeleteMsg">คุณต้องการลบ</span> "<span id="deleteProductName"></span>"?</p>
        <p class="text-muted" data-i18n="cannotUndo">การกระทำนี้ไม่สามารถยกเลิกได้</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-danger" id="confirmDeleteBtn">
          <i class="fas fa-trash"></i> <span data-i18n="delete">ลบ</span>
        </button>
        <button class="btn btn-outline" onclick="closeDeleteModal()" data-i18n="cancel">ยกเลิก</button>
      </div>
    </div>
  </div>

  <!-- Icon Picker Modal -->
  <div id="iconPickerModal" class="picker-modal">
    <div class="picker-content">
      <div class="picker-header">
        <h3 data-i18n="selectIcon">เลือกไอคอน</h3>
        <button class="picker-close" onclick="closeIconPicker()">&times;</button>
      </div>
      <div class="picker-search">
        <i class="fas fa-search"></i>
        <input type="text" id="iconSearch" placeholder="Search icons...">
      </div>
      <div class="icon-grid" id="iconGrid"></div>
    </div>
  </div>

  <!-- Color Picker Modal -->
  <div id="colorPickerModal" class="picker-modal">
    <div class="picker-content color-picker-modal">
      <div class="picker-header">
        <h3 data-i18n="selectColor">เลือกสี</h3>
        <button class="picker-close" onclick="closeColorPicker()">&times;</button>
      </div>
      <div class="color-picker-body">
        <div class="color-wheel-container">
          <canvas id="colorWheel" width="200" height="200"></canvas>
          <div id="colorWheelCursor" class="color-cursor"></div>
        </div>
        <div class="color-slider-container">
          <label>Brightness</label>
          <input type="range" id="brightnessSlider" min="0" max="100" value="50">
        </div>
        <div class="color-presets">
          <h4 data-i18n="presetColors">สีที่แนะนำ</h4>
          <div class="preset-grid">
            <button class="preset-color" style="background: #4a7c59" data-color="#4a7c59"></button>
            <button class="preset-color" style="background: #c4785a" data-color="#c4785a"></button>
            <button class="preset-color" style="background: #6b7f5c" data-color="#6b7f5c"></button>
            <button class="preset-color" style="background: #8b4513" data-color="#8b4513"></button>
            <button class="preset-color" style="background: #2e8b57" data-color="#2e8b57"></button>
            <button class="preset-color" style="background: #daa520" data-color="#daa520"></button>
            <button class="preset-color" style="background: #cd853f" data-color="#cd853f"></button>
            <button class="preset-color" style="background: #556b2f" data-color="#556b2f"></button>
            <button class="preset-color" style="background: #8fbc8f" data-color="#8fbc8f"></button>
            <button class="preset-color" style="background: #bc8f8f" data-color="#bc8f8f"></button>
            <button class="preset-color" style="background: #f4a460" data-color="#f4a460"></button>
            <button class="preset-color" style="background: #6b8e23" data-color="#6b8e23"></button>
          </div>
        </div>
        <div class="selected-color-display">
          <div id="selectedColorBox" class="selected-color-box" style="background: #4a7c59"></div>
          <input type="text" id="colorHexInput" value="#4a7c59" maxlength="7">
        </div>
        <button class="btn btn-primary" onclick="confirmColorSelection()" data-i18n="confirm">ยืนยัน</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script src="js/admin.js"></script>
  <script>
    // ========================================
    // Language System (Thai/English) - Default: Thai
    // ========================================
    const translations = {
      th: {
        adminPanel: 'แผงควบคุม',
        selectIcon: 'เลือกไอคอน',
        selectColor: 'เลือกสี',
        presetColors: 'สีที่แนะนำ',
        confirm: 'ยืนยัน',
        viewSite: 'ดูเว็บไซต์',
        logout: 'ออกจากระบบ',
        dashboard: 'แดชบอร์ด',
        addProduct: 'เพิ่มสินค้า',
        productList: 'รายการสินค้า',
        categories: 'หมวดหมู่',
        totalProducts: 'สินค้าทั้งหมด',
        welcomeTitle: 'ยินดีต้อนรับสู่แผงควบคุม',
        welcomeDesc: 'จัดการสินค้าของฟาร์มได้ง่ายๆ เพิ่มสินค้าใหม่ แก้ไข หรือลบสินค้าจากแคตตาล็อก',
        addNewProduct: 'เพิ่มสินค้าใหม่',
        viewAllProducts: 'ดูสินค้าทั้งหมด',
        productName: 'ชื่อสินค้า *',
        productNamePlaceholder: 'เช่น มะเขือเทศสด',
        category: 'หมวดหมู่ *',
        selectCategory: 'เลือกหมวดหมู่',
        description: 'รายละเอียด *',
        descriptionPlaceholder: 'อธิบายสินค้าของคุณ...',
        price: 'ราคา (฿)',
        pricePlaceholder: 'เช่น 50 หรือ ตามฤดูกาล',
        badge: 'ป้าย (ไม่บังคับ)',
        noBadge: 'ไม่มีป้าย',
        popular: 'ยอดนิยม',
        new: 'ใหม่',
        sale: 'ลดราคา',
        organic: 'ออร์แกนิค',
        imageUrl: 'URL รูปภาพ',
        imageUrlPlaceholder: 'ใส่ URL รูปภาพ หรือเว้นว่างเพื่อใช้รูปเริ่มต้น',
        imageUrlHint: 'เว้นว่างเพื่อใช้รูปเริ่มต้นตามหมวดหมู่',
        uploadImage: 'อัพโหลดรูปภาพ (ไม่บังคับ)',
        uploadNewImage: 'อัพโหลดรูปใหม่',
        dragDrop: 'คลิกเพื่ออัพโหลด หรือลากไฟล์มาวาง',
        reset: 'รีเซ็ต',
        searchProducts: 'ค้นหาสินค้า...',
        allCategories: 'ทุกหมวดหมู่',
        image: 'รูปภาพ',
        name: 'ชื่อ',
        actions: 'จัดการ',
        noProductsFound: 'ไม่พบสินค้า',
        addFirstProduct: 'เพิ่มสินค้าแรกของคุณ',
        addNewCategory: 'เพิ่มหมวดหมู่ใหม่',
        categoryNameEn: 'ชื่อหมวดหมู่ (อังกฤษ)',
        categoryNameTh: 'ชื่อหมวดหมู่ (ไทย)',
        categoryIcon: 'ไอคอน',
        categoryColor: 'สี',
        addCategory: 'เพิ่มหมวดหมู่',
        existingCategories: 'หมวดหมู่ที่มีอยู่',
        editProduct: 'แก้ไขสินค้า',
        save: 'บันทึก',
        cancel: 'ยกเลิก',
        confirmDelete: 'ยืนยันการลบ',
        confirmDeleteMsg: 'คุณต้องการลบ',
        cannotUndo: 'การกระทำนี้ไม่สามารถยกเลิกได้',
        delete: 'ลบ',
        productAdded: 'เพิ่มสินค้าสำเร็จ!',
        productUpdated: 'อัพเดทสินค้าสำเร็จ!',
        productDeleted: 'ลบสินค้าสำเร็จ!',
        categoryAdded: 'เพิ่มหมวดหมู่สำเร็จ!',
        categoryDeleted: 'ลบหมวดหมู่สำเร็จ!',
        categoryExists: 'หมวดหมู่นี้มีอยู่แล้ว',
        error: 'เกิดข้อผิดพลาด'
      },
      en: {
        adminPanel: 'Admin Panel',
        selectIcon: 'Select Icon',
        selectColor: 'Select Color',
        presetColors: 'Preset Colors',
        confirm: 'Confirm',
        viewSite: 'View Site',
        logout: 'Logout',
        dashboard: 'Dashboard',
        addProduct: 'Add Product',
        productList: 'Product List',
        categories: 'Categories',
        totalProducts: 'Total Products',
        welcomeTitle: 'Welcome to Admin Panel',
        welcomeDesc: 'Manage your farm products easily. Add new products, edit existing ones, or remove items from your catalog.',
        addNewProduct: 'Add New Product',
        viewAllProducts: 'View All Products',
        productName: 'Product Name *',
        productNamePlaceholder: 'e.g., Fresh Tomatoes',
        category: 'Category *',
        selectCategory: 'Select Category',
        description: 'Description *',
        descriptionPlaceholder: 'Describe your product...',
        price: 'Price (฿)',
        pricePlaceholder: 'e.g., 50 or Seasonal',
        badge: 'Badge (optional)',
        noBadge: 'No Badge',
        popular: 'Popular',
        new: 'New',
        sale: 'Sale',
        organic: 'Organic',
        imageUrl: 'Image URL',
        imageUrlPlaceholder: 'Enter image URL or leave empty for default',
        imageUrlHint: 'Leave empty to use default category image',
        uploadImage: 'Upload Image (optional)',
        uploadNewImage: 'Upload New Image',
        dragDrop: 'Click to upload or drag and drop',
        reset: 'Reset',
        searchProducts: 'Search products...',
        allCategories: 'All Categories',
        image: 'Image',
        name: 'Name',
        actions: 'Actions',
        noProductsFound: 'No products found',
        addFirstProduct: 'Add Your First Product',
        addNewCategory: 'Add New Category',
        categoryNameEn: 'Category Name (English)',
        categoryNameTh: 'Category Name (Thai)',
        categoryIcon: 'Icon',
        categoryColor: 'Color',
        addCategory: 'Add Category',
        existingCategories: 'Existing Categories',
        editProduct: 'Edit Product',
        save: 'Save',
        cancel: 'Cancel',
        confirmDelete: 'Confirm Delete',
        confirmDeleteMsg: 'Are you sure you want to delete',
        cannotUndo: 'This action cannot be undone.',
        delete: 'Delete',
        productAdded: 'Product added successfully!',
        productUpdated: 'Product updated successfully!',
        productDeleted: 'Product deleted successfully!',
        categoryAdded: 'Category added successfully!',
        categoryDeleted: 'Category deleted successfully!',
        categoryExists: 'Category already exists',
        error: 'Error occurred'
      }
    };

    // Default to Thai
    let currentLang = localStorage.getItem('adminLang') || 'th';

    function t(key) {
      return translations[currentLang][key] || translations['th'][key] || key;
    }

    function updateLanguage() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[currentLang][key]) {
          el.textContent = translations[currentLang][key];
        }
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (translations[currentLang][key]) {
          el.placeholder = translations[currentLang][key];
        }
      });
      document.getElementById('currentLang').textContent = currentLang.toUpperCase();
      
      // Update category selects with correct language
      updateCategorySelects();
    }

    document.getElementById('langToggle').addEventListener('click', function() {
      currentLang = currentLang === 'th' ? 'en' : 'th';
      localStorage.setItem('adminLang', currentLang);
      updateLanguage();
      loadCategoryList();
    });

    // ========================================
    // Category Management
    // ========================================
    const DEFAULT_CATEGORIES = [
      { id: 'vegetables', name: 'Vegetables', nameTh: 'ผัก', icon: 'fas fa-seedling', color: '#4a7c59' },
      { id: 'flowers', name: 'Flowers', nameTh: 'ดอกไม้', icon: 'fas fa-spa', color: '#c4785a' },
      { id: 'herbs', name: 'Herbs', nameTh: 'สมุนไพร', icon: 'fas fa-leaf', color: '#6b7f5c' }
    ];

    function getCategories() {
      const stored = localStorage.getItem('farmCategories');
      return stored ? JSON.parse(stored) : DEFAULT_CATEGORIES;
    }

    function saveCategories(categories) {
      localStorage.setItem('farmCategories', JSON.stringify(categories));
    }

    function getCategoryName(categoryId) {
      const categories = getCategories();
      const cat = categories.find(c => c.id === categoryId);
      if (!cat) return categoryId;
      return currentLang === 'th' ? cat.nameTh : cat.name;
    }

    function updateCategorySelects() {
      const categories = getCategories();
      const selects = ['productCategory', 'editCategory', 'filterCategory'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        const currentValue = select.value;
        const isFilter = selectId === 'filterCategory';
        
        select.innerHTML = isFilter 
          ? `<option value="all">${t('allCategories')}</option>` 
          : `<option value="">${t('selectCategory')}</option>`;
        
        categories.forEach(cat => {
          const displayName = currentLang === 'th' ? cat.nameTh : cat.name;
          select.innerHTML += `<option value="${cat.id}">${displayName}</option>`;
        });
        
        if (currentValue) select.value = currentValue;
      });
    }

    function loadCategoryList() {
      const categories = getCategories();
      const list = document.getElementById('categoryList');
      
      list.innerHTML = categories.map(cat => `
        <div class="category-item" style="border-left: 4px solid ${cat.color}">
          <div class="category-info">
            <i class="${cat.icon}" style="color: ${cat.color}"></i>
            <div>
              <strong>${currentLang === 'th' ? cat.nameTh : cat.name}</strong>
              <span class="category-name-th">${currentLang === 'th' ? cat.name : cat.nameTh}</span>
            </div>
          </div>
          <div class="category-actions">
            <button class="btn-icon delete" onclick="deleteCategory('${cat.id}')" title="${t('delete')}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    function loadCategoryStats() {
      const categories = getCategories();
      const container = document.getElementById('categoryStatsContainer');
      
      container.innerHTML = categories.slice(0, 3).map((cat, index) => `
        <div class="stat-card">
          <div class="stat-icon" style="background: ${cat.color}"><i class="${cat.icon}"></i></div>
          <div class="stat-info">
            <h3 id="catCount${index}">0</h3>
            <p>${currentLang === 'th' ? cat.nameTh : cat.name}</p>
          </div>
        </div>
      `).join('');
    }

    document.getElementById('addCategoryForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const categories = getCategories();
      
      const newCategory = {
        id: document.getElementById('categoryName').value.toLowerCase().replace(/\s+/g, '-'),
        name: document.getElementById('categoryName').value,
        nameTh: document.getElementById('categoryNameTh').value,
        icon: document.getElementById('categoryIcon').value || 'fas fa-box',
        color: document.getElementById('categoryColor').value
      };
      
      if (categories.find(c => c.id === newCategory.id)) {
        showToast(t('categoryExists'), 'error');
        return;
      }
      
      categories.push(newCategory);
      saveCategories(categories);
      loadCategoryList();
      updateCategorySelects();
      loadCategoryStats();
      this.reset();
      document.getElementById('categoryColor').value = '#4a7c59';
      showToast(t('categoryAdded'), 'success');
    });

    function deleteCategory(categoryId) {
      if (!confirm(currentLang === 'th' ? 'ต้องการลบหมวดหมู่นี้หรือไม่?' : 'Delete this category?')) {
        return;
      }
      
      let categories = getCategories();
      categories = categories.filter(c => c.id !== categoryId);
      saveCategories(categories);
      loadCategoryList();
      updateCategorySelects();
      loadCategoryStats();
      showToast(t('categoryDeleted'), 'success');
    }

    // ========================================
    // Authentication & Navigation
    // ========================================
    if (!isAdminLoggedIn()) {
      window.location.href = 'admin.html';
    }

    document.addEventListener('DOMContentLoaded', async function() {
      updateLanguage();
      loadCategoryList();
      loadCategoryStats();
      updateCategorySelects();
      await updateDashboardStats();
      await loadProductTable();
    });

    document.getElementById('logoutBtn').addEventListener('click', function() {
      adminLogout();
      window.location.href = 'admin.html';
    });

    // Sidebar navigation
    document.querySelectorAll('.sidebar-link').forEach(link => {
      link.addEventListener('click', async function(e) {
        e.preventDefault();
        await showPage(this.dataset.page);
      });
    });

    async function showPage(pageName) {
      // Update sidebar
      document.querySelectorAll('.sidebar-link').forEach(link => {
        link.classList.toggle('active', link.dataset.page === pageName);
      });
      // Update pages
      document.querySelectorAll('.admin-page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageName + '-page').classList.add('active');
      
      // Refresh data if needed
      if (pageName === 'dashboard') await updateDashboardStats();
      if (pageName === 'list-products') await loadProductTable();
    }

    // Dashboard stats (async)
    async function updateDashboardStats() {
      const products = await getProductsAsync();
      const categories = getCategories();
      
      document.getElementById('totalProducts').textContent = products.length;
      
      // Update dynamic category stats
      categories.slice(0, 3).forEach((cat, index) => {
        const countEl = document.getElementById(`catCount${index}`);
        if (countEl) {
          countEl.textContent = products.filter(p => p.category === cat.id).length;
        }
      });
    }

    // Add Product Form (async)
    document.getElementById('addProductForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const product = {
        name: document.getElementById('productName').value,
        category: document.getElementById('productCategory').value,
        description: document.getElementById('productDescription').value,
        price: document.getElementById('productPrice').value || 'Seasonal',
        badge: document.getElementById('productBadge').value,
        image: document.getElementById('productImage').value || getDefaultImage(document.getElementById('productCategory').value)
      };
      
      try {
        await addProductToDB(product);
        showToast(t('productAdded'), 'success');
        this.reset();
        document.getElementById('imagePreview').innerHTML = '';
        await updateDashboardStats();
      } catch (error) {
        showToast(t('error') + ': ' + error.message, 'error');
      }
    });

    // Image upload area
    const imageUploadArea = document.getElementById('imageUploadArea');
    const imageFileInput = document.getElementById('productImageFile');
    
    imageUploadArea.addEventListener('click', () => imageFileInput.click());
    imageUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      imageUploadArea.classList.add('dragover');
    });
    imageUploadArea.addEventListener('dragleave', () => {
      imageUploadArea.classList.remove('dragover');
    });
    imageUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      imageUploadArea.classList.remove('dragover');
      handleImageFile(e.dataTransfer.files[0]);
    });
    imageFileInput.addEventListener('change', (e) => {
      handleImageFile(e.target.files[0]);
    });

    function handleImageFile(file) {
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('productImage').value = e.target.result;
          document.getElementById('imagePreview').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
        };
        reader.readAsDataURL(file);
      }
    }

    // Product Table (async)
    async function loadProductTable() {
      const products = await getProductsAsync();
      const tbody = document.getElementById('productTableBody');
      const noProducts = document.getElementById('noProducts');
      const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
      const filterCat = document.getElementById('filterCategory').value;

      let filtered = products.filter(p => {
        const matchSearch = p.name.toLowerCase().includes(searchTerm) || (p.description && p.description.toLowerCase().includes(searchTerm));
        const matchCategory = filterCat === 'all' || p.category === filterCat;
        return matchSearch && matchCategory;
      });

      if (filtered.length === 0) {
        tbody.innerHTML = '';
        noProducts.style.display = 'block';
        return;
      }

      noProducts.style.display = 'none';
      tbody.innerHTML = filtered.map(product => `
        <tr>
          <td>
            <div class="product-thumb-container">
              <img src="${product.image || 'images/phoomjai.svg'}" alt="${product.name}" class="product-thumb">
              <label class="thumb-upload-btn" title="${t('uploadNewImage')}">
                <i class="fas fa-camera"></i>
                <input type="file" accept="image/*" onchange="uploadProductImage(${product.id}, this)" hidden>
              </label>
            </div>
          </td>
          <td>${product.name}</td>
          <td><span class="category-badge ${product.category}">${capitalizeFirst(product.category)}</span></td>
          <td>${product.price || 'Seasonal'}</td>
          <td>${product.badge ? `<span class="product-badge">${product.badge}</span>` : '-'}</td>
          <td class="actions">
            <button class="btn-icon edit" onclick="openEditModal(${product.id})" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon delete" onclick="openDeleteModal(${product.id}, '${product.name}')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    // Upload image directly from product list
    async function uploadProductImage(productId, input) {
      const file = input.files[0];
      if (!file || !file.type.startsWith('image/')) return;
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        const dataUrl = e.target.result;
        try {
          await updateProductInDB(productId, { image: dataUrl });
          await loadProductTable();
          showToast(t('productUpdated'), 'success');
        } catch (error) {
          showToast(t('error') + ': ' + error.message, 'error');
        }
      };
      reader.readAsDataURL(file);
    }

    // Search and filter
    document.getElementById('searchProducts').addEventListener('input', loadProductTable);
    document.getElementById('filterCategory').addEventListener('change', loadProductTable);

    // Edit Modal (async)
    async function openEditModal(productId) {
      const products = await getProductsAsync();
      const product = products.find(p => p.id === productId);
      if (!product) return;

      document.getElementById('editProductId').value = product.id;
      document.getElementById('editName').value = product.name;
      document.getElementById('editCategory').value = product.category;
      document.getElementById('editDescription').value = product.description || '';
      document.getElementById('editPrice').value = product.price || '';
      document.getElementById('editBadge').value = product.badge || '';
      document.getElementById('editImage').value = product.image || '';

      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      document.getElementById('editImagePreview').innerHTML = '';
    }

    // Edit image upload area
    const editImageUploadArea = document.getElementById('editImageUploadArea');
    const editImageFileInput = document.getElementById('editProductImageFile');
    
    editImageUploadArea.addEventListener('click', () => editImageFileInput.click());
    editImageUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      editImageUploadArea.classList.add('dragover');
    });
    editImageUploadArea.addEventListener('dragleave', () => {
      editImageUploadArea.classList.remove('dragover');
    });
    editImageUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      editImageUploadArea.classList.remove('dragover');
      handleEditImageFile(e.dataTransfer.files[0]);
    });
    editImageFileInput.addEventListener('change', (e) => {
      handleEditImageFile(e.target.files[0]);
    });

    function handleEditImageFile(file) {
      if (!file || !file.type.startsWith('image/')) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const dataUrl = e.target.result;
        document.getElementById('editImage').value = dataUrl;
        document.getElementById('editImagePreview').innerHTML = `
          <img src="${dataUrl}" alt="Preview">
          <button type="button" class="remove-preview" onclick="clearEditImagePreview()">
            <i class="fas fa-times"></i>
          </button>
        `;
      };
      reader.readAsDataURL(file);
    }

    function clearEditImagePreview() {
      document.getElementById('editImagePreview').innerHTML = '';
      document.getElementById('editProductImageFile').value = '';
    }

    document.getElementById('editProductForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const productId = parseInt(document.getElementById('editProductId').value);
      const updatedProduct = {
        name: document.getElementById('editName').value,
        category: document.getElementById('editCategory').value,
        description: document.getElementById('editDescription').value,
        price: document.getElementById('editPrice').value || 'Seasonal',
        badge: document.getElementById('editBadge').value,
        image: document.getElementById('editImage').value
      };

      try {
        await updateProductInDB(productId, updatedProduct);
        closeEditModal();
        await loadProductTable();
        await updateDashboardStats();
        showToast(t('productUpdated'), 'success');
      } catch (error) {
        showToast(t('error') + ': ' + error.message, 'error');
      }
    });

    // Delete Modal
    let productToDelete = null;

    function openDeleteModal(productId, productName) {
      productToDelete = productId;
      document.getElementById('deleteProductName').textContent = productName;
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
      productToDelete = null;
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
      if (productToDelete) {
        try {
          await deleteProductFromDB(productToDelete);
          closeDeleteModal();
          await loadProductTable();
          await updateDashboardStats();
          showToast(t('productDeleted'), 'success');
        } catch (error) {
          showToast(t('error') + ': ' + error.message, 'error');
        }
      }
    });

    // Close modals on outside click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
        }
      });
    });

    // Helper functions
    function capitalizeFirst(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function getDefaultImage(category) {
      const defaults = {
        vegetables: 'images/vegetables-leafy.svg',
        flowers: 'images/flowers-roses.svg',
        herbs: 'images/herbs.svg'
      };
      return defaults[category] || 'images/phoomjai.svg';
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ========================================
    // Icon Picker
    // ========================================
    const FARM_ICONS = [
      'fas fa-seedling', 'fas fa-leaf', 'fas fa-spa', 'fas fa-carrot', 'fas fa-apple-alt',
      'fas fa-lemon', 'fas fa-pepper-hot', 'fas fa-tree', 'fas fa-pagelines', 'fab fa-pagelines',
      'fas fa-fan', 'fas fa-sun', 'fas fa-water', 'fas fa-cloud-rain', 'fas fa-tractor',
      'fas fa-box', 'fas fa-boxes', 'fas fa-basket-shopping', 'fas fa-warehouse', 'fas fa-store',
      'fas fa-tags', 'fas fa-tag', 'fas fa-heart', 'fas fa-star', 'fas fa-certificate',
      'fas fa-egg', 'fas fa-bread-slice', 'fas fa-cheese', 'fas fa-fish', 'fas fa-drumstick-bite',
      'fas fa-wheat-awn', 'fas fa-plant-wilt', 'fas fa-clover', 'fas fa-cannabis',
      'fas fa-bucket', 'fas fa-scissors', 'fas fa-spray-can', 'fas fa-hand-holding-droplet',
      'fas fa-temperature-high', 'fas fa-snowflake', 'fas fa-umbrella', 'fas fa-wind'
    ];

    let selectedIcon = 'fas fa-box';

    function openIconPicker() {
      const grid = document.getElementById('iconGrid');
      grid.innerHTML = FARM_ICONS.map(icon => `
        <button type="button" class="icon-option ${icon === selectedIcon ? 'selected' : ''}" data-icon="${icon}">
          <i class="${icon}"></i>
        </button>
      `).join('');

      grid.querySelectorAll('.icon-option').forEach(btn => {
        btn.addEventListener('click', () => selectIcon(btn.dataset.icon));
      });

      document.getElementById('iconPickerModal').classList.add('active');
    }

    function closeIconPicker() {
      document.getElementById('iconPickerModal').classList.remove('active');
    }

    function selectIcon(icon) {
      selectedIcon = icon;
      document.getElementById('categoryIcon').value = icon;
      document.getElementById('selectedIconPreview').className = icon;
      closeIconPicker();
    }

    document.getElementById('iconPickerBtn').addEventListener('click', openIconPicker);

    document.getElementById('iconSearch').addEventListener('input', function(e) {
      const search = e.target.value.toLowerCase();
      document.querySelectorAll('.icon-option').forEach(btn => {
        const icon = btn.dataset.icon.toLowerCase();
        btn.style.display = icon.includes(search) ? 'flex' : 'none';
      });
    });

    // ========================================
    // Color Picker
    // ========================================
    let selectedColor = '#4a7c59';
    let colorWheel, colorCtx;

    function openColorPicker() {
      document.getElementById('colorPickerModal').classList.add('active');
      initColorWheel();
    }

    function closeColorPicker() {
      document.getElementById('colorPickerModal').classList.remove('active');
    }

    function initColorWheel() {
      colorWheel = document.getElementById('colorWheel');
      colorCtx = colorWheel.getContext('2d');
      drawColorWheel();
    }

    function drawColorWheel() {
      const centerX = colorWheel.width / 2;
      const centerY = colorWheel.height / 2;
      const radius = Math.min(centerX, centerY) - 5;
      const brightness = document.getElementById('brightnessSlider').value / 100;

      // Clear canvas
      colorCtx.clearRect(0, 0, colorWheel.width, colorWheel.height);

      // Draw color wheel
      for (let angle = 0; angle < 360; angle++) {
        const startAngle = (angle - 1) * Math.PI / 180;
        const endAngle = (angle + 1) * Math.PI / 180;

        colorCtx.beginPath();
        colorCtx.moveTo(centerX, centerY);
        colorCtx.arc(centerX, centerY, radius, startAngle, endAngle);
        colorCtx.closePath();

        // Create gradient from center to edge
        const gradient = colorCtx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
        const hue = angle;
        gradient.addColorStop(0, `hsl(${hue}, 0%, ${brightness * 100}%)`);
        gradient.addColorStop(1, `hsl(${hue}, 100%, ${brightness * 50}%)`);
        
        colorCtx.fillStyle = gradient;
        colorCtx.fill();
      }
    }

    colorWheel?.addEventListener('click', function(e) {
      const rect = colorWheel.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const pixel = colorCtx.getImageData(x, y, 1, 1).data;
      const hex = rgbToHex(pixel[0], pixel[1], pixel[2]);
      
      updateSelectedColor(hex);
      
      // Move cursor
      const cursor = document.getElementById('colorWheelCursor');
      cursor.style.left = x + 'px';
      cursor.style.top = y + 'px';
    });

    document.getElementById('brightnessSlider')?.addEventListener('input', drawColorWheel);

    document.querySelectorAll('.preset-color').forEach(btn => {
      btn.addEventListener('click', () => updateSelectedColor(btn.dataset.color));
    });

    document.getElementById('colorHexInput')?.addEventListener('input', function(e) {
      let hex = e.target.value;
      if (!hex.startsWith('#')) hex = '#' + hex;
      if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
        updateSelectedColor(hex);
      }
    });

    function updateSelectedColor(hex) {
      selectedColor = hex;
      document.getElementById('selectedColorBox').style.background = hex;
      document.getElementById('colorHexInput').value = hex;
    }

    function confirmColorSelection() {
      document.getElementById('categoryColor').value = selectedColor;
      document.getElementById('colorPreview').style.background = selectedColor;
      closeColorPicker();
    }

    document.getElementById('colorPickerBtn').addEventListener('click', openColorPicker);

    function rgbToHex(r, g, b) {
      return '#' + [r, g, b].map(x => {
        const hex = x.toString(16);
        return hex.length === 1 ? '0' + hex : hex;
      }).join('');
    }

    // Close picker modals on outside click
    document.querySelectorAll('.picker-modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
        }
      });
    });
  </script>
</body>
</html>
