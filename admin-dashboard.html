<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard — Farm Phoomjai & Jiaranai Garden</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-body">
  <!-- Admin Navbar -->
  <nav class="admin-navbar">
    <div class="admin-navbar-brand">
      <img src="images/logo_farm.jpg" alt="Farm Phoomjai">
      <span data-i18n="adminPanel">แผงควบคุม</span>
    </div>
    <div class="admin-navbar-actions">
      <button id="langToggle" class="lang-toggle" title="เปลี่ยนภาษา">
        <i class="fas fa-globe"></i> <span id="currentLang">TH</span>
      </button>
      <a href="index.html" class="admin-nav-link" target="_blank">
        <i class="fas fa-external-link-alt"></i> <span data-i18n="viewSite">ดูเว็บไซต์</span>
      </a>
      <button id="logoutBtn" class="admin-logout-btn">
        <i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">ออกจากระบบ</span>
      </button>
    </div>
  </nav>

  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <nav class="admin-sidebar-nav">
        <a href="#" class="sidebar-link active" data-page="dashboard">
          <i class="fas fa-tachometer-alt"></i>
          <span data-i18n="dashboard">แดชบอร์ด</span>
        </a>
        <a href="#" class="sidebar-link" data-page="add-product">
          <i class="fas fa-plus-circle"></i>
          <span data-i18n="addProduct">เพิ่มสินค้า</span>
        </a>
        <a href="#" class="sidebar-link" data-page="list-products">
          <i class="fas fa-list"></i>
          <span data-i18n="productList">รายการสินค้า</span>
        </a>
        <a href="#" class="sidebar-link" data-page="categories">
          <i class="fas fa-tags"></i>
          <span data-i18n="categories">หมวดหมู่</span>
        </a>
        <a href="#" class="sidebar-link" data-page="badges">
          <i class="fas fa-certificate"></i>
          <span data-i18n="badges">ป้าย</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <!-- Dashboard Page -->
      <section id="dashboard-page" class="admin-page active">
        <h1 class="admin-page-title" data-i18n="dashboard">แดชบอร์ด</h1>
        <div class="dashboard-stats">
          <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-box"></i></div>
            <div class="stat-info">
              <h3 id="totalProducts">0</h3>
              <p data-i18n="totalProducts">สินค้าทั้งหมด</p>
            </div>
          </div>
          <div id="categoryStatsContainer">
            <!-- Dynamic category stats will be loaded here -->
          </div>
        </div>
        <div class="dashboard-welcome">
          <h2 data-i18n="welcomeTitle">ยินดีต้อนรับสู่แผงควบคุม</h2>
          <p data-i18n="welcomeDesc">จัดการสินค้าของฟาร์มได้ง่ายๆ เพิ่มสินค้าใหม่ แก้ไข หรือลบสินค้าจากแคตตาล็อก</p>
          <div class="quick-actions">
            <button class="btn btn-primary" onclick="showPage('add-product')">
              <i class="fas fa-plus"></i> <span data-i18n="addNewProduct">เพิ่มสินค้าใหม่</span>
            </button>
            <button class="btn btn-outline" onclick="showPage('list-products')">
              <i class="fas fa-list"></i> <span data-i18n="viewAllProducts">ดูสินค้าทั้งหมด</span>
            </button>
          </div>
        </div>
      </section>

      <!-- Add Product Page -->
      <section id="add-product-page" class="admin-page">
        <h1 class="admin-page-title" data-i18n="addProduct">เพิ่มสินค้าใหม่</h1>
        <form id="addProductForm" class="admin-form">
          <div class="form-row">
            <div class="form-group">
              <label data-i18n="productNameTh">ชื่อสินค้า (ไทย) *</label>
              <input type="text" id="productNameTh" placeholder="เช่น มะเขือเทศสด" required>
            </div>
            <div class="form-group">
              <label data-i18n="productNameEn">ชื่อสินค้า (อังกฤษ) *</label>
              <input type="text" id="productNameEn" placeholder="e.g., Fresh Tomatoes" required>
            </div>
            <div class="form-group">
              <label for="productCategory" data-i18n="category">หมวดหมู่ *</label>
              <select id="productCategory" required>
                <!-- Categories loaded dynamically -->
              </select>
            </div>
          </div>
          <div class="form-group">
            <label data-i18n="descriptionTh">รายละเอียด (ไทย) *</label>
            <textarea id="productDescriptionTh" rows="3" placeholder="อธิบายสินค้าของคุณ..." required></textarea>
          </div>
          <div class="form-group">
            <label data-i18n="descriptionEn">Description (English) *</label>
            <textarea id="productDescriptionEn" rows="3" placeholder="Describe your product..." required></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="productPrice" data-i18n="price">ราคา (฿)</label>
              <input type="text" id="productPrice" data-i18n-placeholder="pricePlaceholder" placeholder="เช่น 50 หรือ ตามฤดูกาล">
            </div>
            <div class="form-group">
              <label for="productBadge" data-i18n="badge">ป้าย (ไม่บังคับ)</label>
              <select id="productBadge">
                <option value="" data-i18n="noBadge">ไม่มีป้าย</option>
                <option value="Popular" data-i18n="popular">ยอดนิยม</option>
                <option value="New" data-i18n="new">ใหม่</option>
                <option value="Sale" data-i18n="sale">ลดราคา</option>
                <option value="Organic" data-i18n="organic">ออร์แกนิค</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="productImage" data-i18n="imageUrl">URL รูปภาพ</label>
            <input type="text" id="productImage" data-i18n-placeholder="imageUrlPlaceholder" placeholder="ใส่ URL รูปภาพ หรือเว้นว่างเพื่อใช้รูปเริ่มต้น">
            <small data-i18n="imageUrlHint">เว้นว่างเพื่อใช้รูปเริ่มต้นตามหมวดหมู่</small>
          </div>
          <div class="form-group">
            <label data-i18n="uploadImage">อัพโหลดรูปภาพ (ไม่บังคับ)</label>
            <div class="image-upload-area" id="imageUploadArea">
              <i class="fas fa-cloud-upload-alt"></i>
              <p data-i18n="dragDrop">คลิกเพื่ออัพโหลด หรือลากไฟล์มาวาง</p>
              <input type="file" id="productImageFile" accept="image/*" hidden>
            </div>
            <div id="imagePreview" class="image-preview"></div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i> <span data-i18n="addProduct">เพิ่มสินค้า</span>
            </button>
            <button type="reset" class="btn btn-outline">
              <i class="fas fa-undo"></i> <span data-i18n="reset">รีเซ็ต</span>
            </button>
          </div>
        </form>
      </section>

      <!-- List Products Page -->
      <section id="list-products-page" class="admin-page">
        <h1 class="admin-page-title" data-i18n="productList">รายการสินค้า</h1>
        <div class="product-list-header">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchProducts" data-i18n-placeholder="searchProducts" placeholder="ค้นหาสินค้า...">
          </div>
          <select id="filterCategory" class="filter-select">
            <!-- Categories loaded dynamically -->
          </select>
        </div>
        <div class="product-table-container">
          <table class="product-table">
            <thead>
              <tr>
                <th data-i18n="image">รูปภาพ</th>
                <th data-i18n="name">ชื่อ</th>
                <th data-i18n="category">หมวดหมู่</th>
                <th data-i18n="price">ราคา</th>
                <th data-i18n="badge">ป้าย</th>
                <th data-i18n="actions">จัดการ</th>
              </tr>
            </thead>
            <tbody id="productTableBody">
              <!-- Products will be loaded here -->
            </tbody>
          </table>
          <div id="noProducts" class="no-products" style="display: none;">
            <i class="fas fa-box-open"></i>
            <p data-i18n="noProductsFound">ไม่พบสินค้า</p>
            <button class="btn btn-primary" onclick="showPage('add-product')" data-i18n="addFirstProduct">เพิ่มสินค้าแรกของคุณ</button>
          </div>
        </div>
      </section>

      <!-- Categories Page -->
      <section id="categories-page" class="admin-page">
        <h1 class="admin-page-title" data-i18n="categories">หมวดหมู่</h1>
        <div class="categories-container">
          <div class="category-form-section">
            <h3 data-i18n="addNewCategory">เพิ่มหมวดหมู่ใหม่</h3>
            <form id="addCategoryForm" class="admin-form">
              <div class="form-row">
                <div class="form-group">
                  <label data-i18n="categoryNameEn">ชื่อหมวดหมู่ (อังกฤษ)</label>
                  <input type="text" id="categoryName" placeholder="e.g., fruits" required>
                </div>
                <div class="form-group">
                  <label data-i18n="categoryNameTh">ชื่อหมวดหมู่ (ไทย)</label>
                  <input type="text" id="categoryNameTh" placeholder="เช่น ผลไม้" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label data-i18n="categoryIcon">ไอคอน</label>
                  <div class="icon-picker-container">
                    <button type="button" id="iconPickerBtn" class="icon-picker-btn">
                      <i id="selectedIconPreview" class="fas fa-box"></i>
                      <span data-i18n="selectIcon">เลือกไอคอน</span>
                      <i class="fas fa-chevron-down"></i>
                    </button>
                    <input type="hidden" id="categoryIcon" value="fas fa-box">
                  </div>
                </div>
                <div class="form-group">
                  <label data-i18n="categoryColor">สี</label>
                  <div class="color-picker-container">
                    <button type="button" id="colorPickerBtn" class="color-picker-btn">
                      <span id="colorPreview" class="color-preview" style="background: #4a7c59"></span>
                      <span data-i18n="selectColor">เลือกสี</span>
                    </button>
                    <input type="hidden" id="categoryColor" value="#4a7c59">
                  </div>
                </div>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-plus"></i> <span data-i18n="addCategory">เพิ่มหมวดหมู่</span>
                </button>
              </div>
            </form>
          </div>
          <div class="category-list-section">
            <h3 data-i18n="existingCategories">หมวดหมู่ที่มีอยู่</h3>
            <div id="categoryList" class="category-list"></div>
          </div>
        </div>
      </section>

      <!-- Badges Page -->
      <section id="badges-page" class="admin-page">
        <h1 class="admin-page-title" data-i18n="badges">ป้าย (Badge)</h1>
        <div class="categories-container">
          <div class="category-form-section">
            <h3 data-i18n="addNewBadge">เพิ่มป้ายใหม่</h3>
            <form id="addBadgeForm" class="admin-form">
              <div class="form-row">
                <div class="form-group">
                  <label data-i18n="badgeNameEn">ชื่อป้าย (อังกฤษ)</label>
                  <input type="text" id="badgeName" placeholder="e.g., Popular" required>
                </div>
                <div class="form-group">
                  <label data-i18n="badgeNameTh">ชื่อป้าย (ไทย)</label>
                  <input type="text" id="badgeNameTh" placeholder="เช่น ยอดนิยม" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label data-i18n="badgeColor">สี</label>
                  <div class="color-picker-container">
                    <button type="button" id="badgeColorPickerBtn" class="color-picker-btn">
                      <span id="badgeColorPreview" class="color-preview" style="background: #4a7c59"></span>
                      <span data-i18n="selectColor">เลือกสี</span>
                    </button>
                    <input type="hidden" id="badgeColor" value="#4a7c59">
                  </div>
                </div>
                <div class="form-group"></div>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-plus"></i> <span data-i18n="addBadge">เพิ่มป้าย</span>
                </button>
              </div>
            </form>
          </div>
          <div class="category-list-section">
            <h3 data-i18n="existingBadges">ป้ายที่มีอยู่</h3>
            <div id="badgeList" class="category-list"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Edit Category Modal -->
  <div id="editCategoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-i18n="editCategory">แก้ไขหมวดหมู่</h2>
        <button class="modal-close" onclick="closeEditCategoryModal()">&times;</button>
      </div>
      <form id="editCategoryForm" class="admin-form">
        <input type="hidden" id="editCategoryId">
        <div class="form-row">
          <div class="form-group">
            <label data-i18n="categoryNameEn">ชื่อหมวดหมู่ (อังกฤษ)</label>
            <input type="text" id="editCatName" required>
          </div>
          <div class="form-group">
            <label data-i18n="categoryNameTh">ชื่อหมวดหมู่ (ไทย)</label>
            <input type="text" id="editCatNameTh" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label data-i18n="categoryIcon">ไอคอน</label>
            <div class="icon-picker-container">
              <button type="button" id="editIconPickerBtn" class="icon-picker-btn">
                <i id="editSelectedIconPreview" class="fas fa-box"></i>
                <span data-i18n="selectIcon">เลือกไอคอน</span>
                <i class="fas fa-chevron-down"></i>
              </button>
              <input type="hidden" id="editCategoryIcon" value="fas fa-box">
            </div>
          </div>
          <div class="form-group">
            <label data-i18n="categoryColor">สี</label>
            <div class="color-picker-container">
              <button type="button" id="editColorPickerBtn" class="color-picker-btn">
                <span id="editColorPreview" class="color-preview" style="background: #4a7c59"></span>
                <span data-i18n="selectColor">เลือกสี</span>
              </button>
              <input type="hidden" id="editCategoryColor" value="#4a7c59">
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> <span data-i18n="save">บันทึก</span>
          </button>
          <button type="button" class="btn btn-outline" onclick="closeEditCategoryModal()" data-i18n="cancel">ยกเลิก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-i18n="editProduct">แก้ไขสินค้า</h2>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
        <form id="editProductForm" class="admin-form">
        <input type="hidden" id="editProductId">
        <div class="form-row">
          <div class="form-group">
            <label data-i18n="productNameTh">ชื่อสินค้า (ไทย) *</label>
            <input type="text" id="editNameTh" required>
          </div>
          <div class="form-group">
            <label data-i18n="productNameEn">ชื่อสินค้า (อังกฤษ) *</label>
            <input type="text" id="editNameEn" required>
          </div>
          <div class="form-group">
            <label for="editCategory" data-i18n="category">หมวดหมู่ *</label>
            <select id="editCategory" required>
              <!-- Categories loaded dynamically -->
            </select>
          </div>
        </div>
        <div class="form-group">
          <label data-i18n="descriptionTh">รายละเอียด (ไทย) *</label>
          <textarea id="editDescriptionTh" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label data-i18n="descriptionEn">Description (English) *</label>
          <textarea id="editDescriptionEn" rows="3" required></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editPrice" data-i18n="price">ราคา (฿)</label>
            <input type="text" id="editPrice">
          </div>
          <div class="form-group">
            <label for="editBadge" data-i18n="badge">ป้าย</label>
            <select id="editBadge">
              <option value="" data-i18n="noBadge">ไม่มีป้าย</option>
              <option value="Popular" data-i18n="popular">ยอดนิยม</option>
              <option value="New" data-i18n="new">ใหม่</option>
              <option value="Sale" data-i18n="sale">ลดราคา</option>
              <option value="Organic" data-i18n="organic">ออร์แกนิค</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="editImage" data-i18n="imageUrl">URL รูปภาพ</label>
          <input type="text" id="editImage">
        </div>
        <div class="form-group">
          <label data-i18n="uploadNewImage">อัพโหลดรูปใหม่</label>
          <div class="image-upload-area" id="editImageUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p data-i18n="dragDrop">คลิกเพื่ออัพโหลด หรือลากไฟล์มาวาง</p>
            <input type="file" id="editProductImageFile" accept="image/*" hidden>
          </div>
          <div id="editImagePreview" class="image-preview"></div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> <span data-i18n="save">บันทึก</span>
          </button>
          <button type="button" class="btn btn-outline" onclick="closeEditModal()" data-i18n="cancel">ยกเลิก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content modal-small">
      <div class="modal-header">
        <h2 data-i18n="confirmDelete">ยืนยันการลบ</h2>
        <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p><span data-i18n="confirmDeleteMsg">คุณต้องการลบ</span> "<span id="deleteProductName"></span>"?</p>
        <p class="text-muted" data-i18n="cannotUndo">การกระทำนี้ไม่สามารถยกเลิกได้</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-danger" id="confirmDeleteBtn">
          <i class="fas fa-trash"></i> <span data-i18n="delete">ลบ</span>
        </button>
        <button class="btn btn-outline" onclick="closeDeleteModal()" data-i18n="cancel">ยกเลิก</button>
      </div>
    </div>
  </div>

  <!-- Icon Picker Modal -->
  <div id="iconPickerModal" class="picker-modal">
    <div class="picker-content">
      <div class="picker-header">
        <h3 data-i18n="selectIcon">เลือกไอคอน</h3>
        <button class="picker-close" onclick="closeIconPicker()">&times;</button>
      </div>
      <div class="picker-search">
        <i class="fas fa-search"></i>
        <input type="text" id="iconSearch" placeholder="Search icons...">
      </div>
      <div class="icon-grid" id="iconGrid"></div>
    </div>
  </div>

  <!-- Color Picker Modal -->
  <div id="colorPickerModal" class="picker-modal">
    <div class="picker-content color-picker-modal">
      <div class="picker-header">
        <h3 data-i18n="selectColor">เลือกสี</h3>
        <button class="picker-close" onclick="closeColorPicker()">&times;</button>
      </div>
      <div class="color-picker-body">
        <!-- Color Presets - Primary Method (Touch Friendly) -->
        <div class="color-presets">
          <h4 data-i18n="presetColors">สีที่แนะนำ</h4>
          <div class="preset-grid preset-grid-large">
            <button type="button" class="preset-color-btn" style="background: #4a7c59" data-color="#4a7c59" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #c4785a" data-color="#c4785a" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #6b7f5c" data-color="#6b7f5c" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #8b4513" data-color="#8b4513" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #2e8b57" data-color="#2e8b57" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #daa520" data-color="#daa520" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #cd853f" data-color="#cd853f" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #556b2f" data-color="#556b2f" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #8fbc8f" data-color="#8fbc8f" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #bc8f8f" data-color="#bc8f8f" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #f4a460" data-color="#f4a460" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #6b8e23" data-color="#6b8e23" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #e74c3c" data-color="#e74c3c" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #9b59b6" data-color="#9b59b6" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #3498db" data-color="#3498db" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #1abc9c" data-color="#1abc9c" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #f39c12" data-color="#f39c12" onclick="selectPresetColor(this)"></button>
            <button type="button" class="preset-color-btn" style="background: #34495e" data-color="#34495e" onclick="selectPresetColor(this)"></button>
          </div>
        </div>
        
        <!-- Custom Color Input -->
        <div class="custom-color-section">
          <h4>กรอก Hex Code</h4>
          <div class="selected-color-display">
            <div id="selectedColorBox" class="selected-color-box" style="background: #4a7c59"></div>
            <input type="text" id="colorHexInput" value="#4a7c59" maxlength="7" placeholder="#4a7c59">
          </div>
        </div>
        
        <button type="button" class="btn btn-primary" onclick="confirmColorSelection()" data-i18n="confirm">ยืนยัน</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script src="js/admin.js"></script>
  <script>
    // ========================================
    // Language System (Thai/English) - Default: Thai
    // ========================================
    const translations = {
      th: {
        adminPanel: 'แผงควบคุม',
        selectIcon: 'เลือกไอคอน',
        selectColor: 'เลือกสี',
        presetColors: 'สีที่แนะนำ',
        confirm: 'ยืนยัน',
        viewSite: 'ดูเว็บไซต์',
        logout: 'ออกจากระบบ',
        dashboard: 'แดชบอร์ด',
        addProduct: 'เพิ่มสินค้า',
        productList: 'รายการสินค้า',
        categories: 'หมวดหมู่',
        totalProducts: 'สินค้าทั้งหมด',
        welcomeTitle: 'ยินดีต้อนรับสู่แผงควบคุม',
        welcomeDesc: 'จัดการสินค้าของฟาร์มได้ง่ายๆ เพิ่มสินค้าใหม่ แก้ไข หรือลบสินค้าจากแคตตาล็อก',
        addNewProduct: 'เพิ่มสินค้าใหม่',
        viewAllProducts: 'ดูสินค้าทั้งหมด',
        productName: 'ชื่อสินค้า *',
        productNamePlaceholder: 'เช่น มะเขือเทศสด',
        category: 'หมวดหมู่ *',
        selectCategory: 'เลือกหมวดหมู่',
        description: 'รายละเอียด *',
        descriptionPlaceholder: 'อธิบายสินค้าของคุณ...',
        price: 'ราคา (฿)',
        pricePlaceholder: 'เช่น 50 หรือ ตามฤดูกาล',
        badge: 'ป้าย (ไม่บังคับ)',
        noBadge: 'ไม่มีป้าย',
        popular: 'ยอดนิยม',
        new: 'ใหม่',
        sale: 'ลดราคา',
        organic: 'ออร์แกนิค',
        imageUrl: 'URL รูปภาพ',
        imageUrlPlaceholder: 'ใส่ URL รูปภาพ หรือเว้นว่างเพื่อใช้รูปเริ่มต้น',
        imageUrlHint: 'เว้นว่างเพื่อใช้รูปเริ่มต้นตามหมวดหมู่',
        productNameEn: 'ชื่อสินค้า (อังกฤษ) *',
        productNameTh: 'ชื่อสินค้า (ไทย) *',
        productNamePlaceholderEn: 'e.g., Fresh Tomatoes',
        productNamePlaceholderTh: 'เช่น มะเขือเทศสด',
        descriptionEn: 'รายละเอียด (อังกฤษ) *',
        descriptionTh: 'รายละเอียด (ไทย) *',
        descriptionPlaceholderEn: 'Describe your product...',
        descriptionPlaceholderTh: 'อธิบายสินค้าของคุณ...',
        uploadImage: 'อัพโหลดรูปภาพ (ไม่บังคับ)',
        uploadNewImage: 'อัพโหลดรูปใหม่',
        dragDrop: 'คลิกเพื่ออัพโหลด หรือลากไฟล์มาวาง',
        reset: 'รีเซ็ต',
        searchProducts: 'ค้นหาสินค้า...',
        allCategories: 'ทุกหมวดหมู่',
        image: 'รูปภาพ',
        name: 'ชื่อ',
        actions: 'จัดการ',
        noProductsFound: 'ไม่พบสินค้า',
        addFirstProduct: 'เพิ่มสินค้าแรกของคุณ',
        addNewCategory: 'เพิ่มหมวดหมู่ใหม่',
        categoryNameEn: 'ชื่อหมวดหมู่ (อังกฤษ)',
        categoryNameTh: 'ชื่อหมวดหมู่ (ไทย)',
        categoryIcon: 'ไอคอน',
        categoryColor: 'สี',
        addCategory: 'เพิ่มหมวดหมู่',
        existingCategories: 'หมวดหมู่ที่มีอยู่',
        editProduct: 'แก้ไขสินค้า',
        save: 'บันทึก',
        cancel: 'ยกเลิก',
        confirmDelete: 'ยืนยันการลบ',
        confirmDeleteMsg: 'คุณต้องการลบ',
        cannotUndo: 'การกระทำนี้ไม่สามารถยกเลิกได้',
        delete: 'ลบ',
        productAdded: 'เพิ่มสินค้าสำเร็จ!',
        productUpdated: 'อัพเดทสินค้าสำเร็จ!',
        productDeleted: 'ลบสินค้าสำเร็จ!',
        categoryAdded: 'เพิ่มหมวดหมู่สำเร็จ!',
        categoryDeleted: 'ลบหมวดหมู่สำเร็จ!',
        categorySaved: 'บันทึกหมวดหมู่สำเร็จ!',
        categoryExists: 'หมวดหมู่นี้มีอยู่แล้ว',
        editCategory: 'แก้ไขหมวดหมู่',
        edit: 'แก้ไข',
        badges: 'ป้าย',
        addNewBadge: 'เพิ่มป้ายใหม่',
        badgeNameEn: 'ชื่อป้าย (อังกฤษ)',
        badgeNameTh: 'ชื่อป้าย (ไทย)',
        badgeColor: 'สี',
        addBadge: 'เพิ่มป้าย',
        existingBadges: 'ป้ายที่มีอยู่',
        editBadge: 'แก้ไขป้าย',
        badgeAdded: 'เพิ่มป้ายสำเร็จ!',
        badgeDeleted: 'ลบป้ายสำเร็จ!',
        badgeSaved: 'บันทึกป้ายสำเร็จ!',
        badgeExists: 'ป้ายนี้มีอยู่แล้ว',
        error: 'เกิดข้อผิดพลาด'
      },
      en: {
        adminPanel: 'Admin Panel',
        selectIcon: 'Select Icon',
        selectColor: 'Select Color',
        presetColors: 'Preset Colors',
        confirm: 'Confirm',
        viewSite: 'View Site',
        logout: 'Logout',
        dashboard: 'Dashboard',
        addProduct: 'Add Product',
        productList: 'Product List',
        categories: 'Categories',
        totalProducts: 'Total Products',
        welcomeTitle: 'Welcome to Admin Panel',
        welcomeDesc: 'Manage your farm products easily. Add new products, edit existing ones, or remove items from your catalog.',
        addNewProduct: 'Add New Product',
        viewAllProducts: 'View All Products',
        productName: 'Product Name *',
        productNamePlaceholder: 'e.g., Fresh Tomatoes',
        category: 'Category *',
        selectCategory: 'Select Category',
        description: 'Description *',
        descriptionPlaceholder: 'Describe your product...',
        price: 'Price (฿)',
        pricePlaceholder: 'e.g., 50 or Seasonal',
        badge: 'Badge (optional)',
        noBadge: 'No Badge',
        popular: 'Popular',
        new: 'New',
        sale: 'Sale',
        organic: 'Organic',
        imageUrl: 'Image URL',
        imageUrlPlaceholder: 'Enter image URL or leave empty for default',
        imageUrlHint: 'Leave empty to use default category image',
        productNameEn: 'Product Name (English) *',
        productNameTh: 'Product Name (Thai) *',
        productNamePlaceholderEn: 'e.g., Fresh Tomatoes',
        productNamePlaceholderTh: 'เช่น มะเขือเทศสด',
        descriptionEn: 'Description (English) *',
        descriptionTh: 'Description (Thai) *',
        descriptionPlaceholderEn: 'Describe your product...',
        descriptionPlaceholderTh: 'อธิบายสินค้าของคุณ...',
        uploadImage: 'Upload Image (optional)',
        uploadNewImage: 'Upload New Image',
        dragDrop: 'Click to upload or drag and drop',
        reset: 'Reset',
        searchProducts: 'Search products...',
        allCategories: 'All Categories',
        image: 'Image',
        name: 'Name',
        actions: 'Actions',
        noProductsFound: 'No products found',
        addFirstProduct: 'Add Your First Product',
        addNewCategory: 'Add New Category',
        categoryNameEn: 'Category Name (English)',
        categoryNameTh: 'Category Name (Thai)',
        categoryIcon: 'Icon',
        categoryColor: 'Color',
        addCategory: 'Add Category',
        existingCategories: 'Existing Categories',
        editProduct: 'Edit Product',
        save: 'Save',
        cancel: 'Cancel',
        confirmDelete: 'Confirm Delete',
        confirmDeleteMsg: 'Are you sure you want to delete',
        cannotUndo: 'This action cannot be undone.',
        delete: 'Delete',
        productAdded: 'Product added successfully!',
        productUpdated: 'Product updated successfully!',
        productDeleted: 'Product deleted successfully!',
        categoryAdded: 'Category added successfully!',
        categoryDeleted: 'Category deleted successfully!',
        categorySaved: 'Category saved successfully!',
        categoryExists: 'Category already exists',
        editCategory: 'Edit Category',
        edit: 'Edit',
        badges: 'Badges',
        addNewBadge: 'Add New Badge',
        badgeNameEn: 'Badge Name (English)',
        badgeNameTh: 'Badge Name (Thai)',
        badgeColor: 'Color',
        addBadge: 'Add Badge',
        existingBadges: 'Existing Badges',
        editBadge: 'Edit Badge',
        badgeAdded: 'Badge added successfully!',
        badgeDeleted: 'Badge deleted successfully!',
        badgeSaved: 'Badge saved successfully!',
        badgeExists: 'Badge already exists',
        error: 'Error occurred'
      }
    };

    // Default to Thai
    let currentLang = localStorage.getItem('adminLang') || 'th';

    function t(key) {
      return translations[currentLang][key] || translations['th'][key] || key;
    }

    function updateLanguage() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[currentLang][key]) {
          el.textContent = translations[currentLang][key];
        }
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (translations[currentLang][key]) {
          el.placeholder = translations[currentLang][key];
        }
      });
      document.getElementById('currentLang').textContent = currentLang.toUpperCase();
      
      // Update category selects with correct language
      updateCategorySelects();
    }

    document.getElementById('langToggle').addEventListener('click', function() {
      currentLang = currentLang === 'th' ? 'en' : 'th';
      localStorage.setItem('adminLang', currentLang);
      updateLanguage();
      loadCategoryList();
    });

    // ========================================
    // Category Management (Supabase + localStorage fallback)
    // ========================================
    const DEFAULT_CATEGORIES = [
      { id: 'vegetables', name: 'Vegetables', nameTh: 'ผัก', icon: 'fas fa-seedling', color: '#4a7c59' },
      { id: 'flowers', name: 'Flowers', nameTh: 'ดอกไม้', icon: 'fas fa-spa', color: '#c4785a' },
      { id: 'herbs', name: 'Herbs', nameTh: 'สมุนไพร', icon: 'fas fa-leaf', color: '#6b7f5c' }
    ];

    // Use localStorage as primary storage (will sync with Supabase when available)
    function getCategories() {
      const stored = localStorage.getItem('farmCategories');
      return stored ? JSON.parse(stored) : DEFAULT_CATEGORIES;
    }

    function saveCategories(categories) {
      localStorage.setItem('farmCategories', JSON.stringify(categories));
      // Sync to product.html via custom event
      window.dispatchEvent(new CustomEvent('categoriesUpdated', { detail: categories }));
    }

    // Sync categories to Supabase (background)
    async function syncCategoriesToDB() {
      try {
        const categories = getCategories();
        console.log('Syncing categories to Supabase...');
        // This would sync to Supabase if table exists
      } catch (e) {
        console.log('Category sync skipped (table may not exist)');
      }
    }

    function getCategoryName(categoryId) {
      const categories = getCategories();
      const cat = categories.find(c => c.id === categoryId);
      if (!cat) return categoryId;
      return currentLang === 'th' ? cat.nameTh : cat.name;
    }

    function updateCategorySelects() {
      const categories = getCategories();
      const selects = ['productCategory', 'editCategory', 'filterCategory'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        const currentValue = select.value;
        const isFilter = selectId === 'filterCategory';
        
        select.innerHTML = isFilter 
          ? `<option value="all">${t('allCategories')}</option>` 
          : `<option value="">${t('selectCategory')}</option>`;
        
        categories.forEach(cat => {
          const displayName = currentLang === 'th' ? cat.nameTh : cat.name;
          select.innerHTML += `<option value="${cat.id}">${displayName}</option>`;
        });
        
        if (currentValue) select.value = currentValue;
      });
    }

    function loadCategoryList(scrollToBottom = false) {
      const categories = getCategories();
      const list = document.getElementById('categoryList');
      
      list.innerHTML = categories.map((cat, index) => `
        <div class="category-item ${scrollToBottom && index === categories.length - 1 ? 'new-item' : ''}" style="border-left: 4px solid ${cat.color}" data-id="${cat.id}">
          <div class="category-info">
            <i class="${cat.icon}" style="color: ${cat.color}"></i>
            <div>
              <strong>${currentLang === 'th' ? cat.nameTh : cat.name}</strong>
              <span class="category-name-th">${currentLang === 'th' ? cat.name : cat.nameTh}</span>
            </div>
          </div>
          <div class="category-actions">
            <button class="btn-icon edit" onclick="openEditCategoryModal('${cat.id}')" title="${t('edit')}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon delete" onclick="deleteCategory('${cat.id}')" title="${t('delete')}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');
      
      // Scroll to new item if added
      if (scrollToBottom && categories.length > 0) {
        const lastItem = list.querySelector('.new-item');
        if (lastItem) {
          lastItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
          lastItem.classList.add('highlight');
          setTimeout(() => lastItem.classList.remove('highlight', 'new-item'), 2000);
        }
      }
    }

    function loadCategoryStats() {
      const categories = getCategories();
      const container = document.getElementById('categoryStatsContainer');
      
      container.innerHTML = categories.slice(0, 3).map((cat, index) => `
        <div class="stat-card">
          <div class="stat-icon" style="background: ${cat.color}"><i class="${cat.icon}"></i></div>
          <div class="stat-info">
            <h3 id="catCount${index}">0</h3>
            <p>${currentLang === 'th' ? cat.nameTh : cat.name}</p>
          </div>
        </div>
      `).join('');
    }

    document.getElementById('addCategoryForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const categories = getCategories();
      
      const newCategory = {
        id: document.getElementById('categoryName').value.toLowerCase().replace(/\s+/g, '-'),
        name: document.getElementById('categoryName').value,
        nameTh: document.getElementById('categoryNameTh').value,
        icon: document.getElementById('categoryIcon').value || 'fas fa-box',
        color: document.getElementById('categoryColor').value
      };
      
      if (categories.find(c => c.id === newCategory.id)) {
        showToast(t('categoryExists'), 'error');
        return;
      }
      
      categories.push(newCategory);
      saveCategories(categories);
      loadCategoryList(true); // Scroll to new item
      updateCategorySelects();
      loadCategoryStats();
      this.reset();
      document.getElementById('categoryColor').value = '#4a7c59';
      document.getElementById('colorPreview').style.background = '#4a7c59';
      document.getElementById('selectedIconPreview').className = 'fas fa-box';
      document.getElementById('categoryIcon').value = 'fas fa-box';
      showToast(t('categoryAdded'), 'success');
    });

    document.getElementById('editCategoryForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      updateCategory();
    });

    function deleteCategory(categoryId) {
      if (!confirm(currentLang === 'th' ? 'ต้องการลบหมวดหมู่นี้หรือไม่?' : 'Delete this category?')) {
        return;
      }
      
      let categories = getCategories();
      categories = categories.filter(c => c.id !== categoryId);
      saveCategories(categories);
      loadCategoryList();
      updateCategorySelects();
      loadCategoryStats();
      showToast(t('categoryDeleted'), 'success');
    }

    function openEditCategoryModal(categoryId) {
      const categories = getCategories();
      const category = categories.find(c => c.id === categoryId);
      
      if (!category) return;
      
      document.getElementById('editCategoryId').value = categoryId;
      document.getElementById('editCatName').value = category.name;
      document.getElementById('editCatNameTh').value = category.nameTh;
      document.getElementById('editCategoryIcon').value = category.icon;
      document.getElementById('editCategoryColor').value = category.color;
      document.getElementById('editSelectedIconPreview').className = category.icon;
      document.getElementById('editColorPreview').style.background = category.color;
      
      selectedEditIcon = category.icon;
      selectedEditColor = category.color;
      
      document.getElementById('editCategoryModal').classList.add('active');
    }

    function closeEditCategoryModal() {
      document.getElementById('editCategoryModal').classList.remove('active');
    }

    function updateCategory() {
      const categoryId = document.getElementById('editCategoryId').value;
      const name = document.getElementById('editCatName').value.trim();
      const nameTh = document.getElementById('editCatNameTh').value.trim();
      const icon = document.getElementById('editCategoryIcon').value;
      const color = document.getElementById('editCategoryColor').value;
      
      if (!name || !nameTh) {
        showToast(currentLang === 'th' ? 'กรุณากรอกชื่อหมวดหมู่' : 'Please enter category name', 'error');
        return;
      }
      
      let categories = getCategories();
      const index = categories.findIndex(c => c.id === categoryId);
      
      if (index !== -1) {
        categories[index] = {
          ...categories[index],
          name,
          nameTh,
          icon,
          color
        };
        saveCategories(categories);
        loadCategoryList();
        updateCategorySelects();
        loadCategoryStats();
        closeEditCategoryModal();
        showToast(t('categorySaved'), 'success');
      }
    }

    // ========================================
    // Authentication & Navigation
    // ========================================
    if (!isAdminLoggedIn()) {
      window.location.href = 'admin.html';
    }

    document.addEventListener('DOMContentLoaded', async function() {
      updateLanguage();
      loadCategoryList();
      loadCategoryStats();
      updateCategorySelects();
      loadBadgeList();
      updateBadgeSelects();
      await updateDashboardStats();
      await loadProductTable();
    });

    document.getElementById('logoutBtn').addEventListener('click', function() {
      adminLogout();
      window.location.href = 'admin.html';
    });

    // Sidebar navigation
    document.querySelectorAll('.sidebar-link').forEach(link => {
      link.addEventListener('click', async function(e) {
        e.preventDefault();
        await showPage(this.dataset.page);
      });
    });

    async function showPage(pageName) {
      // Update sidebar
      document.querySelectorAll('.sidebar-link').forEach(link => {
        link.classList.toggle('active', link.dataset.page === pageName);
      });
      // Update pages
      document.querySelectorAll('.admin-page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageName + '-page').classList.add('active');
      
      // Refresh data if needed
      if (pageName === 'dashboard') await updateDashboardStats();
      if (pageName === 'list-products') await loadProductTable();
    }

    // Dashboard stats (async)
    async function updateDashboardStats() {
      const products = await getProductsAsync();
      const categories = getCategories();
      
      document.getElementById('totalProducts').textContent = products.length;
      
      // Update dynamic category stats
      categories.slice(0, 3).forEach((cat, index) => {
        const countEl = document.getElementById(`catCount${index}`);
        if (countEl) {
          countEl.textContent = products.filter(p => p.category === cat.id).length;
        }
      });
    }

    // Add Product Form (async)
    document.getElementById('addProductForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const product = {
        name: document.getElementById('productNameEn').value,
        name_th: document.getElementById('productNameTh').value,
        category: document.getElementById('productCategory').value,
        description: document.getElementById('productDescriptionEn').value,
        description_th: document.getElementById('productDescriptionTh').value,
        price: document.getElementById('productPrice').value || 'Seasonal',
        badge: document.getElementById('productBadge').value,
        image: document.getElementById('productImage').value || getDefaultImage(document.getElementById('productCategory').value)
      };

      try {
        await addProductToDB(product);
        showToast(t('productAdded'), 'success');
        this.reset();
        document.getElementById('imagePreview').innerHTML = '';
        await updateDashboardStats();
      } catch (error) {
        showToast(t('error') + ': ' + error.message, 'error');
      }
    });

    // Image upload area
    const imageUploadArea = document.getElementById('imageUploadArea');
    const imageFileInput = document.getElementById('productImageFile');
    
    imageUploadArea.addEventListener('click', () => imageFileInput.click());
    imageUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      imageUploadArea.classList.add('dragover');
    });
    imageUploadArea.addEventListener('dragleave', () => {
      imageUploadArea.classList.remove('dragover');
    });
    imageUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      imageUploadArea.classList.remove('dragover');
      handleImageFile(e.dataTransfer.files[0]);
    });
    imageFileInput.addEventListener('change', (e) => {
      handleImageFile(e.target.files[0]);
    });

    function handleImageFile(file) {
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('productImage').value = e.target.result;
          document.getElementById('imagePreview').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
        };
        reader.readAsDataURL(file);
      }
    }

    // Product Table (async)
    async function loadProductTable() {
      const products = await getProductsAsync();
      const tbody = document.getElementById('productTableBody');
      const noProducts = document.getElementById('noProducts');
      const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
      const filterCat = document.getElementById('filterCategory').value;

      let filtered = products.filter(p => {
        const nameEn = (p.name || '').toLowerCase();
        const nameTh = (p.name_th || '').toLowerCase();
        const descEn = (p.description || '').toLowerCase();
        const descTh = (p.description_th || '').toLowerCase();
        const matchSearch = nameEn.includes(searchTerm) || nameTh.includes(searchTerm) || descEn.includes(searchTerm) || descTh.includes(searchTerm);
        const matchCategory = filterCat === 'all' || p.category === filterCat;
        return matchSearch && matchCategory;
      });

      if (filtered.length === 0) {
        tbody.innerHTML = '';
        noProducts.style.display = 'block';
        return;
      }

      noProducts.style.display = 'none';
      tbody.innerHTML = filtered.map(product => {
        const displayName = currentLang === 'th' ? (product.name_th || product.name) : (product.name || product.name_th);
        const displayPrice = product.price || 'Seasonal';
        const displayBadge = product.badge ? `<span class="product-badge">${product.badge}</span>` : '-';
        const thumb = product.image || 'images/phoomjai.svg';

        return `
        <tr>
          <td>
            <div class="product-thumb-container">
              <img src="${thumb}" alt="${displayName}" class="product-thumb">
              <label class="thumb-upload-btn" title="${t('uploadNewImage')}">
                <i class="fas fa-camera"></i>
                <input type="file" accept="image/*" onchange="uploadProductImage(${product.id}, this)" hidden>
              </label>
            </div>
          </td>
          <td>${displayName}</td>
          <td><span class="category-badge ${product.category}">${capitalizeFirst(product.category)}</span></td>
          <td>${displayPrice}</td>
          <td>${displayBadge}</td>
          <td class="actions">
            <button class="btn-icon edit" onclick="openEditModal(${product.id})" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon delete" onclick="openDeleteModal(${product.id}, '${escapeHtml(displayName)}')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
      }).join('');
    }

    // Upload image directly from product list
    async function uploadProductImage(productId, input) {
      const file = input.files[0];
      if (!file || !file.type.startsWith('image/')) return;
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        const dataUrl = e.target.result;
        try {
          await updateProductInDB(productId, { image: dataUrl });
          await loadProductTable();
          showToast(t('productUpdated'), 'success');
        } catch (error) {
          showToast(t('error') + ': ' + error.message, 'error');
        }
      };
      reader.readAsDataURL(file);
    }

    // Search and filter
    document.getElementById('searchProducts').addEventListener('input', loadProductTable);
    document.getElementById('filterCategory').addEventListener('change', loadProductTable);

    // Edit Modal (async)
    async function openEditModal(productId) {
      const products = await getProductsAsync();
      const product = products.find(p => p.id === productId);
      if (!product) return;

      document.getElementById('editProductId').value = product.id;
      document.getElementById('editNameEn').value = product.name || '';
      document.getElementById('editNameTh').value = product.name_th || '';
      document.getElementById('editCategory').value = product.category;
      document.getElementById('editDescriptionEn').value = product.description || '';
      document.getElementById('editDescriptionTh').value = product.description_th || '';
      document.getElementById('editPrice').value = product.price || '';
      document.getElementById('editBadge').value = product.badge || '';
      document.getElementById('editImage').value = product.image || '';

      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      document.getElementById('editImagePreview').innerHTML = '';
    }

    // Edit image upload area
    const editImageUploadArea = document.getElementById('editImageUploadArea');
    const editImageFileInput = document.getElementById('editProductImageFile');
    
    editImageUploadArea.addEventListener('click', () => editImageFileInput.click());
    editImageUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      editImageUploadArea.classList.add('dragover');
    });
    editImageUploadArea.addEventListener('dragleave', () => {
      editImageUploadArea.classList.remove('dragover');
    });
    editImageUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      editImageUploadArea.classList.remove('dragover');
      handleEditImageFile(e.dataTransfer.files[0]);
    });
    editImageFileInput.addEventListener('change', (e) => {
      handleEditImageFile(e.target.files[0]);
    });

    function handleEditImageFile(file) {
      if (!file || !file.type.startsWith('image/')) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const dataUrl = e.target.result;
        document.getElementById('editImage').value = dataUrl;
        document.getElementById('editImagePreview').innerHTML = `
          <img src="${dataUrl}" alt="Preview">
          <button type="button" class="remove-preview" onclick="clearEditImagePreview()">
            <i class="fas fa-times"></i>
          </button>
        `;
      };
      reader.readAsDataURL(file);
    }

    function clearEditImagePreview() {
      document.getElementById('editImagePreview').innerHTML = '';
      document.getElementById('editProductImageFile').value = '';
    }

    document.getElementById('editProductForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const productId = parseInt(document.getElementById('editProductId').value);
      const updatedProduct = {
        name: document.getElementById('editNameEn').value,
        name_th: document.getElementById('editNameTh').value,
        category: document.getElementById('editCategory').value,
        description: document.getElementById('editDescriptionEn').value,
        description_th: document.getElementById('editDescriptionTh').value,
        price: document.getElementById('editPrice').value || 'Seasonal',
        badge: document.getElementById('editBadge').value,
        image: document.getElementById('editImage').value
      };

      try {
        await updateProductInDB(productId, updatedProduct);
        closeEditModal();
        await loadProductTable();
        await updateDashboardStats();
        showToast(t('productUpdated'), 'success');
      } catch (error) {
        showToast(t('error') + ': ' + error.message, 'error');
      }
    });

    // Delete Modal
    let productToDelete = null;

    function openDeleteModal(productId, productName) {
      productToDelete = productId;
      document.getElementById('deleteProductName').textContent = productName;
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
      productToDelete = null;
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
      if (productToDelete) {
        try {
          await deleteProductFromDB(productToDelete);
          closeDeleteModal();
          await loadProductTable();
          await updateDashboardStats();
          showToast(t('productDeleted'), 'success');
        } catch (error) {
          showToast(t('error') + ': ' + error.message, 'error');
        }
      }
    });

    // Close modals on outside click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
        }
      });
    });

    // Helper functions
    function capitalizeFirst(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    function getDefaultImage(category) {
      const defaults = {
        vegetables: 'images/vegetables-leafy.svg',
        flowers: 'images/flowers-roses.svg',
        herbs: 'images/herbs.svg'
      };
      return defaults[category] || 'images/phoomjai.svg';
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ========================================
    // Icon Picker
    // ========================================
    const FARM_ICONS = [
      'fas fa-seedling', 'fas fa-leaf', 'fas fa-spa', 'fas fa-carrot', 'fas fa-apple-alt',
      'fas fa-lemon', 'fas fa-pepper-hot', 'fas fa-tree', 'fas fa-pagelines', 'fab fa-pagelines',
      'fas fa-fan', 'fas fa-sun', 'fas fa-water', 'fas fa-cloud-rain', 'fas fa-tractor',
      'fas fa-box', 'fas fa-boxes', 'fas fa-basket-shopping', 'fas fa-warehouse', 'fas fa-store',
      'fas fa-tags', 'fas fa-tag', 'fas fa-heart', 'fas fa-star', 'fas fa-certificate',
      'fas fa-egg', 'fas fa-bread-slice', 'fas fa-cheese', 'fas fa-fish', 'fas fa-drumstick-bite',
      'fas fa-wheat-awn', 'fas fa-plant-wilt', 'fas fa-clover', 'fas fa-cannabis',
      'fas fa-bucket', 'fas fa-scissors', 'fas fa-spray-can', 'fas fa-hand-holding-droplet',
      'fas fa-temperature-high', 'fas fa-snowflake', 'fas fa-umbrella', 'fas fa-wind'
    ];

    let selectedIcon = 'fas fa-box';
    let selectedEditIcon = 'fas fa-box';
    let selectedEditColor = '#4a7c59';

    function openIconPicker() {
      const grid = document.getElementById('iconGrid');
      grid.innerHTML = FARM_ICONS.map(icon => `
        <button type="button" class="icon-option ${icon === selectedIcon ? 'selected' : ''}" data-icon="${icon}">
          <i class="${icon}"></i>
        </button>
      `).join('');

      grid.querySelectorAll('.icon-option').forEach(btn => {
        btn.addEventListener('click', () => selectIcon(btn.dataset.icon));
      });

      document.getElementById('iconPickerModal').classList.add('active');
    }

    function closeIconPicker() {
      document.getElementById('iconPickerModal').classList.remove('active');
    }

    function selectIcon(icon) {
      selectedIcon = icon;
      document.getElementById('categoryIcon').value = icon;
      document.getElementById('selectedIconPreview').className = icon;
      closeIconPicker();
    }

    function openEditIconPicker() {
      const grid = document.getElementById('iconGrid');
      grid.innerHTML = FARM_ICONS.map(icon => `
        <button type="button" class="icon-option ${icon === selectedEditIcon ? 'selected' : ''}" data-icon="${icon}">
          <i class="${icon}"></i>
        </button>
      `).join('');

      grid.querySelectorAll('.icon-option').forEach(btn => {
        btn.addEventListener('click', () => selectEditIcon(btn.dataset.icon));
      });

      document.getElementById('iconPickerModal').classList.add('active');
    }

    function selectEditIcon(icon) {
      selectedEditIcon = icon;
      document.getElementById('editCategoryIcon').value = icon;
      document.getElementById('editSelectedIconPreview').className = icon;
      closeIconPicker();
    }

    document.getElementById('iconPickerBtn').addEventListener('click', openIconPicker);
    document.getElementById('editIconPickerBtn')?.addEventListener('click', openEditIconPicker);

    document.getElementById('iconSearch').addEventListener('input', function(e) {
      const search = e.target.value.toLowerCase();
      document.querySelectorAll('.icon-option').forEach(btn => {
        const icon = btn.dataset.icon.toLowerCase();
        btn.style.display = icon.includes(search) ? 'flex' : 'none';
      });
    });

    // ========================================
    // Color Picker (Touch Friendly)
    // ========================================
    let selectedColor = '#4a7c59';
    let isEditColorMode = false;

    function openColorPicker() {
      isEditColorMode = false;
      highlightSelectedColor(selectedColor);
      document.getElementById('colorPickerModal').classList.add('active');
    }

    function closeColorPicker() {
      document.getElementById('colorPickerModal').classList.remove('active');
    }

    // Select preset color (touch friendly)
    function selectPresetColor(btn) {
      const color = btn.dataset.color;
      
      // Remove selected class from all buttons
      document.querySelectorAll('.preset-color-btn').forEach(b => b.classList.remove('selected'));
      
      // Add selected class to clicked button
      btn.classList.add('selected');
      
      // Update display
      document.getElementById('selectedColorBox').style.background = color;
      document.getElementById('colorHexInput').value = color;
      
      // Store in appropriate variable
      if (isEditColorMode) {
        selectedEditColor = color;
      } else {
        selectedColor = color;
      }
    }

    // Highlight the currently selected color
    function highlightSelectedColor(color) {
      document.querySelectorAll('.preset-color-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.color === color);
      });
      document.getElementById('selectedColorBox').style.background = color;
      document.getElementById('colorHexInput').value = color;
    }

    // Hex input handler
    document.getElementById('colorHexInput')?.addEventListener('input', function(e) {
      let hex = e.target.value;
      if (!hex.startsWith('#')) hex = '#' + hex;
      if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
        document.getElementById('selectedColorBox').style.background = hex;
        
        // Remove selected from preset buttons if custom color
        document.querySelectorAll('.preset-color-btn').forEach(btn => {
          btn.classList.toggle('selected', btn.dataset.color === hex);
        });
        
        if (isEditColorMode) {
          selectedEditColor = hex;
        } else {
          selectedColor = hex;
        }
      }
    });

    function updateSelectedColor(hex) {
      selectedColor = hex;
      document.getElementById('selectedColorBox').style.background = hex;
      document.getElementById('colorHexInput').value = hex;
    }

    function updateSelectedEditColor(hex) {
      selectedEditColor = hex;
      document.getElementById('selectedColorBox').style.background = hex;
      document.getElementById('colorHexInput').value = hex;
    }

    function confirmColorSelection() {
      // Check if in edit mode
      if (isEditColorMode) {
        document.getElementById('editCategoryColor').value = selectedEditColor;
        document.getElementById('editColorPreview').style.background = selectedEditColor;
      } else {
        document.getElementById('categoryColor').value = selectedColor;
        document.getElementById('colorPreview').style.background = selectedColor;
      }
      closeColorPicker();
    }

    function openEditColorPicker() {
      isEditColorMode = true;
      selectedEditColor = document.getElementById('editCategoryColor').value;
      highlightSelectedColor(selectedEditColor);
      document.getElementById('colorPickerModal').classList.add('active');
    }

    document.getElementById('colorPickerBtn').addEventListener('click', openColorPicker);
    document.getElementById('editColorPickerBtn')?.addEventListener('click', openEditColorPicker);
    document.getElementById('badgeColorPickerBtn')?.addEventListener('click', () => {
      isEditColorMode = false;
      selectedColor = document.getElementById('badgeColor').value || '#4a7c59';
      highlightSelectedColor(selectedColor);
      document.getElementById('colorPickerModal').classList.add('active');
      // Override confirm to set badge color
      window.confirmColorForBadge = true;
    });

    // Override confirm for badge
    const origConfirmColor = confirmColorSelection;
    confirmColorSelection = function() {
      if (window.confirmColorForBadge) {
        document.getElementById('badgeColor').value = selectedColor;
        document.getElementById('badgeColorPreview').style.background = selectedColor;
        closeColorPicker();
        window.confirmColorForBadge = false;
      } else if (isEditColorMode) {
        document.getElementById('editCategoryColor').value = selectedEditColor;
        document.getElementById('editColorPreview').style.background = selectedEditColor;
        closeColorPicker();
      } else {
        document.getElementById('categoryColor').value = selectedColor;
        document.getElementById('colorPreview').style.background = selectedColor;
        closeColorPicker();
      }
    };

    // ========================================
    // Badge Management
    // ========================================
    const DEFAULT_BADGES = [
      { id: 'popular', name: 'Popular', nameTh: 'ยอดนิยม', color: '#4a7c59' },
      { id: 'new', name: 'New', nameTh: 'ใหม่', color: '#daa520' },
      { id: 'sale', name: 'Sale', nameTh: 'ลดราคา', color: '#e74c3c' },
      { id: 'organic', name: 'Organic', nameTh: 'ออร์แกนิค', color: '#2e8b57' }
    ];

    function getBadges() {
      const stored = localStorage.getItem('farmBadges');
      return stored ? JSON.parse(stored) : DEFAULT_BADGES;
    }

    function saveBadges(badges) {
      localStorage.setItem('farmBadges', JSON.stringify(badges));
    }

    function loadBadgeList() {
      const badges = getBadges();
      const list = document.getElementById('badgeList');
      
      list.innerHTML = badges.map(badge => `
        <div class="category-item" style="border-left: 4px solid ${badge.color}">
          <div class="category-info">
            <span class="badge-preview" style="background: ${badge.color}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${currentLang === 'th' ? badge.nameTh : badge.name}</span>
            <div style="margin-left: 0.5rem;">
              <strong>${currentLang === 'th' ? badge.nameTh : badge.name}</strong>
              <span class="category-name-th">${currentLang === 'th' ? badge.name : badge.nameTh}</span>
            </div>
          </div>
          <div class="category-actions">
            <button class="btn-icon edit" onclick="openEditBadgeModal('${badge.id}')" title="${t('edit')}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon delete" onclick="deleteBadge('${badge.id}')" title="${t('delete')}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    function updateBadgeSelects() {
      const badges = getBadges();
      const selects = ['productBadge', 'editBadge'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        const currentValue = select.value;
        select.innerHTML = `<option value="">${t('noBadge')}</option>`;
        
        badges.forEach(badge => {
          const displayName = currentLang === 'th' ? badge.nameTh : badge.name;
          select.innerHTML += `<option value="${badge.id}">${displayName}</option>`;
        });
        
        if (currentValue) select.value = currentValue;
      });
    }

    document.getElementById('addBadgeForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      const badges = getBadges();
      
      const newBadge = {
        id: document.getElementById('badgeName').value.toLowerCase().replace(/\s+/g, '-'),
        name: document.getElementById('badgeName').value,
        nameTh: document.getElementById('badgeNameTh').value,
        color: document.getElementById('badgeColor').value
      };
      
      if (badges.find(b => b.id === newBadge.id)) {
        showToast(t('badgeExists'), 'error');
        return;
      }
      
      badges.push(newBadge);
      saveBadges(badges);
      loadBadgeList();
      updateBadgeSelects();
      this.reset();
      document.getElementById('badgeColor').value = '#4a7c59';
      document.getElementById('badgeColorPreview').style.background = '#4a7c59';
      showToast(t('badgeAdded'), 'success');
    });

    function deleteBadge(badgeId) {
      if (!confirm(currentLang === 'th' ? 'ต้องการลบป้ายนี้หรือไม่?' : 'Delete this badge?')) {
        return;
      }
      
      let badges = getBadges();
      badges = badges.filter(b => b.id !== badgeId);
      saveBadges(badges);
      loadBadgeList();
      updateBadgeSelects();
      showToast(t('badgeDeleted'), 'success');
    }

    function openEditBadgeModal(badgeId) {
      // Simple edit using prompt for now
      const badges = getBadges();
      const badge = badges.find(b => b.id === badgeId);
      if (!badge) return;
      
      const newName = prompt(currentLang === 'th' ? 'ชื่อป้าย (อังกฤษ):' : 'Badge name (English):', badge.name);
      if (!newName) return;
      
      const newNameTh = prompt(currentLang === 'th' ? 'ชื่อป้าย (ไทย):' : 'Badge name (Thai):', badge.nameTh);
      if (!newNameTh) return;
      
      const index = badges.findIndex(b => b.id === badgeId);
      if (index !== -1) {
        badges[index] = { ...badges[index], name: newName, nameTh: newNameTh };
        saveBadges(badges);
        loadBadgeList();
        updateBadgeSelects();
        showToast(t('badgeSaved'), 'success');
      }
    }

    // Close picker modals on outside click
    document.querySelectorAll('.picker-modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
        }
      });
    });
  </script>
</body>
</html>